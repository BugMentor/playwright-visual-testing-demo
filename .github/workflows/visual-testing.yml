name: Visual Testing Pipeline

on:
push:
  branches: [ main, develop ]
pull_request:
  branches: [ main ]

jobs:
visual-tests:
  runs-on: ubuntu-latest
  
  steps:
  - uses: actions/checkout@v3
  
  - name: Setup Node.js
    uses: actions/setup-node@v3
    with:
      node-version: '18'
      cache: 'npm'
  
  - name: Install dependencies
    run: npm ci
  
  - name: Install Playwright browsers
    run: npx playwright install --with-deps
  
  - name: Run E2E tests
    run: npm test
  
  - name: Run Percy visual tests
    run: npm run test:percy
    env:
      PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
  
  - name: Run Applitools visual tests
    run: npm run test:applitools
    env:
      APPLITOOLS_API_KEY: ${{ secrets.APPLITOOLS_API_KEY }}
  
  - name: Upload Playwright report
    uses: actions/upload-artifact@v3
    if: always()
    with:
      name: playwright-report
      path: playwright-report/
